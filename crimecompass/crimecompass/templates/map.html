<!DOCTYPE html>
<html>
<head>
    <title>Map Directions and Address Autofill</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</head>
<body>

    <p>Starting Location: {{starting_location}}</p>
    <p>Destination: {{destination}}</p>
    <p>Starting Location Coordinates: {{starting_location_coords}}</p>
    <p>Destination Coordinates: {{destination_coords}}</p>

    <div id="map" style="width: 100%; height: 400px;"></div>

    <script>
    var map = L.map('map').setView([38.0293, -78.4767], 13);

    const avoidCoordsArray = [[38.039948, -78.467817], [38.027778, -78.494704], [38.049688, -78.503789], [38.021917, -78.505393], [38.936337, -77.046912], [38.033989, -78.496656], [38.032942, -78.493864], [38.033837, -78.495172], [38.0244, -78.478533], [38.024687, -78.477776], [38.034265, -78.494034], [38.023324, -78.477657], [38.030075, -78.497817], [38.020315, -78.498262], [38.049638, -78.503683], [38.049456, -78.501005], [38.02305, -78.475756], [38.029929, -78.496545], [38.054814, -78.494211], [38.027922, -78.489318], [38.057969, -78.488254], [38.020857, -78.506877], [38.025008, -78.470085], [38.024763, -78.479049], [38.035302, -78.49233], [38.035492, -78.501311], [38.029131, -78.493862], [38.031055, -78.496717], [38.019771, -78.507455], [38.025066, -78.478829], [38.029048, -78.496372], [38.037986, -78.495892], [38.019863, -78.498984], [38.026405, -78.475299], [38.02032, -78.507995], [38.025344, -78.476474], [38.032012, -78.494943], [38.023345, -78.479911], [38.028596, -78.495062], [38.021469, -78.473818], [38.05352, -78.499743], [38.024287, -78.478885], [38.029829, -78.493623], [38.028321, -78.486057], [38.025638, -78.476392], [38.027113, -78.491967], [38.059192, -78.495143], [38.024601, -78.47352], [38.051426, -78.503706], [38.019521, -78.51533], [38.026007, -78.477333], [38.029917, -78.496876], [38.026155, -78.49281], [38.01925, -78.505259], [38.04031, -78.469185], [38.023772, -78.475629], [38.031211, -78.496216], [38.030693, -78.49157], [38.055087, -78.495529], [38.041288, -78.467046], [38.031726, -78.49689], [38.026566, -78.472693], [38.026176, -78.483386], [38.024092, -78.470479], [38.03357, -78.492626], [38.027423, -78.488872], [38.025065, -78.473598], [38.030409, -78.493833], [38.023774, -78.474555], [38.028538, -78.492457], [38.056119, -78.490883], [38.026823, -78.488399], [38.022297, -78.501413], [38.024703, -78.471497], [38.0258, -78.472967], [38.032259, -78.496032], [38.018698, -78.500557], [38.027601, -78.469437], [37.979771, -78.683521], [38.034619, -78.506498], [38.026956, -78.492826], [38.032114, -78.500653], [38.051754, -78.499934], [38.05271, -78.500154], [38.021046, -78.475555], [38.027366, -78.478782], [38.032082, -78.497126], [38.025583, -78.491614], [38.049894, -78.502705], [38.024384, -78.476388], [38.026975, -78.491669], [38.030958, -78.499381], [38.053874, -78.492523], [38.020534, -78.514252], [38.032641, -78.488058], [38.02493, -78.474765], [38.02457, -78.475913], [38.031484, -78.497218], [38.026726, -78.493956], [38.038977, -78.507957], [38.028923, -78.492547], [38.03246, -78.494878], [38.039926, -78.46604], [38.051312, -78.503756], [38.018115, -78.509592], [38.024528, -78.474778], [38.020502, -78.505956], [38.024785, -78.472968], [38.030476, -78.493216], [38.029022, -78.500382], [38.030002, -78.481274], [38.026052, -78.491784], [38.036237, -78.492024], [38.018903, -78.508198], [38.022375, -78.492987], [38.021213, -78.50037], [38.021306, -78.474965], [38.030378, -78.48992], [38.020876, -78.515577], [38.049045, -78.502938], [38.03408, -78.496124], [38.062509, -78.47618], [38.022125, -78.472421], [38.028339, -78.494208], [38.030575, -78.496892], [38.03455, -78.498123], [38.027362, -78.495204], [38.029114, -78.48932], [38.053812, -78.475666], [38.03398, -78.494861], [38.023304, -78.474552], [38.034058, -78.49775], [38.03565, -78.496484], [38.026639, -78.477432], [38.058095, -78.493377], [38.030348, -78.492669], [38.020606, -78.483489], [38.02441, -78.476518], [38.020192, -78.509399], [38.054679, -78.49562], [38.024422, -78.473493], [38.051211, -78.500789], [38.024345, -78.474282], [38.034832, -78.497764], [38.025111, -78.475668], [38.018426, -78.516124], [38.020415, -78.503922], [38.024061, -78.473463], [38.031682, -78.492116], [38.023861, -78.467814], [38.031155, -78.502791], [38.025972, -78.49943], [38.052809, -78.498802], [38.039876, -78.465228], [38.053391, -78.490448], [38.023777, -78.476586], [38.053398, -78.497021], [38.058239, -78.489534], [38.028294, -78.495835], [38.058478, -78.488283], [38.02444, -78.475768], [38.051329, -78.500373], [38.034591, -78.493892], [38.038811, -78.46314], [38.042007, -78.468203], [38.053413, -78.496895], [38.020919, -78.514498], [38.024857, -78.501699], [38.050833, -78.500878], [38.032196, -78.497529], [38.026423, -78.492885], [38.055744, -78.496833], [38.018962, -78.503756], [38.021317, -78.474435], [38.050532, -78.502692], [38.024842, -78.471342], [38.022707, -78.514524], [38.023697, -78.477005], [38.027129, -78.487706], [38.038933, -78.495564], [38.034986, -78.492692], [38.017531, -78.48248], [38.021562, -78.470033], [38.02238, -78.477088], [38.054384, -78.498664], [38.059736, -78.488911], [38.022445, -78.475957], [38.028141, -78.495441], [38.030812, -78.493223], [38.021677, -78.474315], [38.021084, -78.504843], [38.053738, -78.498358], [38.020949, -78.499601], [38.032528, -78.490157], [38.038712, -78.497229], [38.030669, -78.496052], [38.03374, -78.496036], [38.036099, -78.495523], [38.036698, -78.468319], [38.023433, -78.477275]];
    const radius = 25; // Radius in meters

// Add circles to the map for each coordinate
avoidCoordsArray.forEach(coords => {
    L.circle([coords[0], coords[1]], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: radius
    }).addTo(map);
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

    function createAvoidPolygons(coordsArray) {
        const buffer = 0.0006; // Buffer distance
        return coordsArray.map(coords => [
            [coords[0] - buffer, coords[1] - buffer],
            [coords[0] + buffer, coords[1] - buffer],
            [coords[0] + buffer, coords[1] + buffer],
            [coords[0] - buffer, coords[1] + buffer],
            [coords[0] - buffer, coords[1] - buffer]
        ]);
    }

    var avoidAreas = createAvoidPolygons(avoidCoordsArray);

    // Convert avoidAreas to a format compatible with Leaflet polygons and add them to the map
    // avoidAreas.forEach(area => {
    //    L.polygon(area.map(coord => [coord[0], coord[1]]), {
    //        color: 'red',
    //        weight: 3
    //    }).addTo(map);
    //});

    // Convert avoidAreas to a format compatible with the routing API
    const avoidPolygonsForRouting = avoidAreas.map(area => area.map(coord => [coord[1], coord[0]]));

    const options = {
        avoid_polygons: {
            type: "MultiPolygon",
            coordinates: [avoidPolygonsForRouting]
        }
    };

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function addRouteToMap(routeFeatures){
        L.geoJSON(routeFeatures, {
            style: function(feature){
                return {color: "#ff7800", weight: 5};
            },
            onEachFeature: function(feature, layer){
                if (feature.properties && feature.properties.summary){
                    layer.bindPopup('Distance: ${feature.properties.summary.distances} meters');
                }
            }
        }).addTo(map);
    }

    const apiKey = '5b3ce3597851110001cf624847bbb5db0d234327a7a7a31de91d3134';
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=-78.47667810000002,38.0293059&end=-78.4925,38.0366667&options=${encodeURIComponent(JSON.stringify(options))}`;
    //const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf624847bbb5db0d234327a7a7a31de91d3134&start=8.681495,49.41461&end=8.687872,49.420318`
    fetch(url)
        .then(response => response.json())
        .then(data => {
            addRouteToMap(data.features);
        })
        .catch(error => console.error('Error getting data:', error));

    </script>
</body>
</html>
